<!DOCTYPE html>
<html dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>عجلة الحظ</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --background-color: #121212;
            --text-color: #ffffff;
            --primary-color: #fdd835;
            --secondary-color: #212121;
            --disabled-color: #616161;
            --shadow-color: rgba(0, 0, 0, 0.5);
        }
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        html, body {
            height: 100%;
            width: 100%;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background: var(--background-color) url('https://i.postimg.cc/W1k4wg9b/Picsart-25-12-16-19-26-45-331.jpg') no-repeat center center fixed;
            background-size: cover;
            color: var(--text-color);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 15px;
            overflow: hidden;
            position: relative;
        }
        .container {
            max-width: 400px;
            width: 100%;
            text-align: center;
            background: transparent;
            border-radius: 20px;
            padding: 20px;
            box-shadow: none;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        .header { margin-bottom: 20px; width: 100%; text-align: center; }
        .status { font-size: 18px; font-weight: 500; color: #e0e0e0; height: 24px; text-shadow: 0 2px 4px rgba(0,0,0,0.5); margin-bottom: 5px; }
        .timer { font-size: 16px; color: var(--primary-color); height: 20px; text-shadow: 0 2px 4px rgba(0,0,0,0.5); }
        .wheel-container { position: relative; width: 300px; height: 300px; margin: 25px auto; display: flex; align-items: center; justify-content: center; }
        .pointer { position: absolute; top: -15px; left: 50%; transform: translateX(-50%); width: 0; height: 0; border-left: 25px solid transparent; border-right: 25px solid transparent; border-top: 40px solid var(--primary-color); z-index: 10; filter: drop-shadow(0 5px 8px var(--shadow-color)); }
        .wheel { width: 100%; height: 100%; border-radius: 50%; position: relative; overflow: hidden; transition: transform 6s cubic-bezier(0.33, 1, 0.68, 1); box-shadow: 0 0 30px rgba(0,0,0,0.8), inset 0 0 25px rgba(0,0,0,0.6); border: 4px solid #444; display: block; margin: 0 auto; }
        .wheel-center { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 80px; height: 80px; background: var(--secondary-color); border-radius: 50%; display: flex; align-items: center; justify-content: center; text-align: center; font-size: 20px; font-weight: bold; color: var(--primary-color); z-index: 5; border: 4px solid #424242; text-shadow: 0 0 8px var(--primary-color); padding: 5px; line-height: 1.2; box-shadow: inset 0 0 10px rgba(0,0,0,0.5); }
        .spin-btn { background: linear-gradient(180deg, #fdd835, #f9a825); color: var(--secondary-color); border: none; padding: 16px 45px; font-size: 22px; font-weight: bold; border-radius: 50px; cursor: pointer; margin-top: 25px; transition: all 0.2s ease; box-shadow: 0 5px 15px rgba(0,0,0,0.4); width: 80%; max-width: 300px; }
        .spin-btn:hover:not(:disabled) { transform: translateY(-3px); box-shadow: 0 8px 20px rgba(253, 216, 53, 0.3); }
        .spin-btn:disabled { background: var(--disabled-color); color: #9e9e9e; cursor: not-allowed; box-shadow: none; }
        .result-popup { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); backdrop-filter: blur(8px); display: flex; align-items: center; justify-content: center; z-index: 1000; opacity: 0; visibility: hidden; transition: opacity 0.4s, visibility 0.4s; }
        .result-popup.show { opacity: 1; visibility: visible; }
        .result-content { background: #333; padding: 35px; border-radius: 20px; text-align: center; max-width: 90%; width: 360px; border: 2px solid var(--primary-color); transform: scale(0.8); transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .result-popup.show .result-content { transform: scale(1); }
        .prize-text { font-size: 48px; color: var(--primary-color); margin: 20px 0; font-weight: bold; animation: prize-pulse 1.5s infinite; }
        @keyframes prize-pulse { 0%, 100% { transform: scale(1); text-shadow: 0 0 15px var(--primary-color); } 50% { transform: scale(1.1); text-shadow: 0 0 25px var(--primary-color); } }
        .close-btn { background: var(--primary-color); color: var(--secondary-color); border: none; padding: 12px 35px; font-size: 18px; border-radius: 50px; cursor: pointer; font-weight: bold; margin-top: 15px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="status" id="status">...جاري التحقق</div>
            <div class="timer" id="timer"></div>
        </div>
        <div class="wheel-container">
            <div class="pointer"></div>
            <div class="wheel" id="wheel"></div>
            <div class="wheel-center" id="prizeDisplay">?</div>
        </div>
        <button class="spin-btn" id="spinBtn" disabled>...تحميل</button>
    </div>

    <div class="result-popup" id="resultPopup">
        <div class="result-content">
            <h2 style="font-size: 32px;">!تهانينا</h2>
            <p style="font-size: 18px; margin-top: 10px;">:لقد فزت بـ</p>
            <div class="prize-text" id="winPrize"></div>
            <p style="font-size: 14px; color: #bdbdbd;">.سيتم إرسال جائزتك إلى البوت لتفعيلها</p>
            <button class="close-btn" id="closeBtn">إغلاق</button>
        </div>
    </div>

    <script>
        // =================== الإعدادات الرئيسية ===================
        // ⚠️ استبدل هذا الرابط برابط تطبيق الويب المنشور من Google Apps Script
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyouqv84ouox2jA1977k6VgOcd_sbGtmK-cVpnSXqGU4mE_ROYfhDDnKWzdhRjCzEI/exec";

        // الحصول على معرف المستخدم من بارامترات الرابط
        const urlParams = new URLSearchParams(window.location.search);
        const user_id = urlParams.get('user_id');
        // ========================================================

        const prizes = [
            { name: "حظ أوفر", probability: 40 },
            { name: "1000", probability: 5 },
            { name: "2000", probability: 2 },
            { name: "5000", probability: 1 },
            { name: "1000", probability: 5 },
            { name: "2000", probability: 2 },
            { name: "5000", probability: 1 },
            { name: "حظ أوفر", probability: 44 }
        ];
        
        const colors = ["#0d47a1", "#ffffff", "#0d47a1", "#ffffff", "#0d47a1", "#ffffff", "#0d47a1", "#ffffff"];

        const wheel = document.getElementById('wheel');
        const prizeDisplay = document.getElementById('prizeDisplay');
        const spinBtn = document.getElementById('spinBtn');
        const timerEl = document.getElementById('timer');
        const statusEl = document.getElementById('status');
        const resultPopup = document.getElementById('resultPopup');
        const winPrize = document.getElementById('winPrize');
        const closeBtn = document.getElementById('closeBtn');

        let isSpinning = false, canSpin = false, currentRotation = 0, spinAnimation;
        const prizeCount = prizes.length;
        const prizeAngle = 360 / prizeCount;

        function createWheel() {
            let cssSlices = [], currentAngle = 0;
            for (let i = 0; i < prizeCount; i++) {
                const color = colors[i % colors.length];
                const nextAngle = currentAngle + prizeAngle;
                cssSlices.push(`${color} ${currentAngle}deg ${nextAngle}deg`);
                currentAngle = nextAngle;
            }
            wheel.style.background = `conic-gradient(${cssSlices.join(',')})`;
        }

        function getPrizeFromAngle(angle) {
            const correctedAngle = (360 - angle % 360 + prizeAngle / 2) % 360;
            const prizeIndex = Math.floor(correctedAngle / prizeAngle);
            return prizes[prizeIndex].name;
        }

        function updatePrizeDisplay() {
            if (!isSpinning) { cancelAnimationFrame(spinAnimation); return; }
            const transformMatrix = window.getComputedStyle(wheel).getPropertyValue('transform');
            const matrixValues = transformMatrix.match(/matrix.*\((.+)\)/);
            if (matrixValues) {
                const matrix = matrixValues[1].split(',');
                const [a, b] = [parseFloat(matrix[0]), parseFloat(matrix[1])];
                const angle = Math.round(Math.atan2(b, a) * (180 / Math.PI));
                prizeDisplay.textContent = getPrizeFromAngle(angle);
            }
            spinAnimation = requestAnimationFrame(updatePrizeDisplay);
        }

        function selectPrize() {
            let cumulativeProbability = 0;
            const rand = Math.random() * 100;
            for (let i = 0; i < prizes.length; i++) {
                cumulativeProbability += prizes[i].probability;
                if (rand <= cumulativeProbability) return i;
            }
            return prizes.length - 1;
        }

        function spin() {
            if (isSpinning || !canSpin) return;
            isSpinning = true;
            spinBtn.disabled = true;
            spinBtn.textContent = "...حظاً موفقاً";

            const selectedPrizeIndex = selectPrize();
            const prize = prizes[selectedPrizeIndex];
            const randomSpins = Math.floor(Math.random() * 4) + 8;
            const targetAngle = (prizeAngle * selectedPrizeIndex) + (prizeAngle / 2);
            const jitter = (Math.random() - 0.5) * (prizeAngle * 0.8);
            const finalAngle = 360 - (targetAngle + jitter);
            const totalRotation = (randomSpins * 360) + finalAngle;
            currentRotation = totalRotation;

            wheel.style.transform = `rotate(${currentRotation}deg)`;
            spinAnimation = requestAnimationFrame(updatePrizeDisplay);
            wheel.addEventListener('transitionend', () => onSpinEnd(prize.name), { once: true });
        }

        function onSpinEnd(finalPrize) {
            isSpinning = false;
            cancelAnimationFrame(spinAnimation);
            prizeDisplay.textContent = finalPrize;

            if (finalPrize !== "حظ أوفر") {
                saveResult(finalPrize);
                setTimeout(() => showResult(finalPrize), 600);
            } else {
                statusEl.textContent = "حظ أوفر في المرة القادمة";
                updateUI(false, new Date().getTime());
            }
        }
        
        function showResult(prize) {
            winPrize.textContent = prize;
            resultPopup.classList.add('show');
        }

        function closeResult() {
            resultPopup.classList.remove('show');
            // لا نغلق النافذة مباشرة، فقط نحدث الواجهة
            // يمكن للمستخدم إغلاقها بنفسه
        }

        function saveResult(prize) {
            fetch(SCRIPT_URL, {
                method: 'POST',
                body: JSON.stringify({ action: 'save_spin', user_id: user_id, prize: prize }),
                headers: { 'Content-Type': 'application/json' },
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) console.log('Result saved successfully.');
                else console.error('Failed to save result:', data.message);
            })
            .catch(err => console.error('Error saving result:', err));
        }

        function updateUI(canSpinNow, lastTime) {
            canSpin = canSpinNow;
            if (canSpinNow) {
                spinBtn.disabled = false;
                spinBtn.textContent = "تدوير";
                statusEl.textContent = "عجلة الحظ اليومية";
                timerEl.textContent = "";
            } else {
                spinBtn.disabled = true;
                spinBtn.textContent = "نراك غداً";
                statusEl.textContent = "لقد قمت بالتدوير بالفعل اليوم";
                if (lastTime) startTimer(lastTime);
            }
        }

        function startTimer(lastTime) {
            const targetTime = lastTime + (24 * 60 * 60 * 1000);
            const interval = setInterval(() => {
                const timeLeft = targetTime - Date.now();
                if (timeLeft <= 0) {
                    clearInterval(interval);
                    updateUI(true, null);
                    return;
                }
                const h = Math.floor(timeLeft / 3600000);
                const m = Math.floor((timeLeft % 3600000) / 60000);
                const s = Math.floor((timeLeft % 60000) / 1000);
                timerEl.textContent = `الرجاء الانتظار: ${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
            }, 1000);
        }

        function init() {
            Telegram.WebApp.ready();
            createWheel();

            if (!user_id) {
                statusEl.textContent = "خطأ: معرف المستخدم مفقود!";
                spinBtn.disabled = true;
                return;
            }

            fetch(`${SCRIPT_URL}?action=check_user&user_id=${user_id}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        updateUI(data.canSpin, data.lastTime);
                    } else {
                        console.error('Server error:', data.message);
                        updateUI(true, null);
                    }
                })
                .catch(error => {
                    console.error('Fetch error:', error);
                    statusEl.textContent = "خطأ في الاتصال بالخادم";
                    updateUI(true, null);
                });
        }

        window.onload = init;
        spinBtn.addEventListener('click', spin);
        closeBtn.addEventListener('click', closeResult);
    </script>
</body>
</html>
